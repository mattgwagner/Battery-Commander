@model IEnumerable<Vehicle>

@{
    ViewBag.Title = "Vehicle Tracker";

    var fmc_count = Model.Where(_ => _.Status == Vehicle.VehicleStatus.FMC).Count();
    var driver_count = Model.Where(_ => _.DriverId.HasValue).Count();
    var adriver_count = Model.Where(_ => _.A_DriverId.HasValue).Count();
    var pax_count = driver_count + adriver_count;
}

<div class="page-header">
    <h1>
        @ViewBag.Title
        @Html.ActionLink("Add New", "New", "Vehicles", null, new { @class = "btn btn-default" })
        <small>FMC: <span class="badge">@fmc_count</span> PAX: <span class="badge">@pax_count</span></small>
    </h1>
</div>

<table class="table table-striped" id="dt">
    <thead>
        <tr>
            <th>@Html.DisplayNameFor(_ => _.FirstOrDefault().Status)</th>
            <th>@Html.DisplayNameFor(_ => _.FirstOrDefault().Unit)</th>
            <th>@Html.DisplayNameFor(_ => _.FirstOrDefault().Bumper)</th>
            <th>@Html.DisplayNameFor(_ => _.FirstOrDefault().Type)</th>
            <th>@Html.DisplayNameFor(_ => _.FirstOrDefault().Seats)</th>
            <th>@Html.DisplayNameFor(_ => _.FirstOrDefault().Nomenclature)</th>
            <th>@Html.DisplayNameFor(_ => _.FirstOrDefault().Registration)</th>
            <th>@Html.DisplayNameFor(_ => _.FirstOrDefault().Serial)</th>
            <th>@Html.DisplayNameFor(_ => _.FirstOrDefault().LIN)</th>
            <th>@Html.DisplayNameFor(_ => _.FirstOrDefault().Driver)</th>
            <th>@Html.DisplayNameFor(_ => _.FirstOrDefault().A_Driver)</th>
            <th>@Html.DisplayNameFor(_ => _.FirstOrDefault().Notes)</th>
            <th></th>
        </tr>
    </thead>

    <tbody>
        @foreach (var vehicle in Model)
        {
            <tr>
                <td>
                    <span class="update-status" data-vehicle="@vehicle.Id" data-status="@((int)vehicle.Status)" data-notes="@vehicle.Notes">
                        @Html.DisplayFor(_ => vehicle, "VehicleStatus")
                    </span>
                </td>
                <td>@Html.DisplayFor(_ => vehicle.Unit)</td>
                <td>@Html.DisplayFor(_ => vehicle.Bumper)</td>
                <td>@Html.DisplayFor(_ => vehicle.Type)</td>
                <td>@Html.DisplayFor(_ => vehicle.Seats)</td>
                <td>@Html.DisplayFor(_ => vehicle.Nomenclature)</td>
                <td>@Html.DisplayFor(_ => vehicle.Registration)</td>
                <td>@Html.DisplayFor(_ => vehicle.Serial)</td>
                <td>@Html.DisplayFor(_ => vehicle.LIN)</td>
                <td>
                    @if (vehicle.DriverId.HasValue)
                    {
                        <span class="update-driver" data-vehicle="@vehicle.Id" data-bumper="@vehicle.Bumper" data-driver="@vehicle.DriverId" data-adriver="@vehicle.A_DriverId">@Html.DisplayFor(_ => vehicle.Driver)</span>
                    }
                    else
                    {
                        <span class="update-driver label label-default" data-vehicle="@vehicle.Id" data-bumper="@vehicle.Bumper" data-driver="@vehicle.DriverId" data-adriver="@vehicle.A_DriverId">(Empty)</span>
                    }
                </td>
                <td>
                    @if (vehicle.A_DriverId.HasValue)
                    {
                        <span class="update-driver" data-vehicle="@vehicle.Id" data-bumper="@vehicle.Bumper" data-driver="@vehicle.DriverId" data-adriver="@vehicle.A_DriverId">@Html.DisplayFor(_ => vehicle.A_Driver)</span>
                    }
                    else
                    {
                        <span class="update-driver label label-default" data-vehicle="@vehicle.Id" data-bumper="@vehicle.Bumper" data-driver="@vehicle.DriverId" data-adriver="@vehicle.A_DriverId">(Empty)</span>
                    }
                </td>
                <td>@Html.DisplayFor(_ => vehicle.Notes)</td>
                <td>@Html.ActionLink("Edit", "Edit", new { vehicle.Id })
            </tr>
        }
    </tbody>
</table>

<div style="display:none" id="set-driver" title="Update Driver/A-Driver">
    @using (Html.BeginForm("SetDriver", "Vehicles", FormMethod.Post, new { @class = "form-horizontal", role = "form" }))
    {
        <input id="vehicleId" name="vehicleId" type="hidden" />

        <div class="form-group form-group-lg">
            @Html.Label("Driver")
            @Html.DropDownList("driverId", (IEnumerable<SelectListItem>)ViewBag.Soldiers, "-- Select Driver --")
        </div>

        <div class="form-group form-group-lg">
            @Html.Label("A-Driver")
            @Html.DropDownList("adriverId", (IEnumerable<SelectListItem>)ViewBag.Soldiers, "-- Select A-Driver --")
        </div>

        <button type="submit" id="save">Save</button>
    }
</div>

<div style="display:none" id="set-status" title="Update Vehicle Status">
    @using (Html.BeginForm("SetStatus", "Vehicles", FormMethod.Post, new { @class = "form-horizontal", role = "form" }))
    {
        <input id="vehicleId" name="vehicleId" type="hidden" />

        <div class="form-group form-group-lg">
            @Html.Label("Status")
            @Html.DropDownList("status", Html.GetEnumSelectList<Vehicle.VehicleStatus>())
        </div>

        <div class="form-group form-group-lg">
            @Html.Label("Notes")
            @Html.TextArea("notes")
        </div>

        <button type="submit" id="save">Save</button>
    }
</div>

@section Scripts{
    <script type="text/javascript">
        $(document).ready(function () {
            $("td .update-driver").click(function (e) {
                e.preventDefault();
                $("[name='vehicleId']").val($(this).data('vehicle'));
                $("#driverId").val($(this).data('driver')).trigger('change');
                $("#adriverId").val($(this).data('adriver')).trigger('change');

                $("#set-driver").dialog({
                    modal: true
                });
            });

            $("td .update-status").click(function (e) {
                $("[name='vehicleId']").val($(this).data('vehicle'));
                $("#status").val($(this).data('status')).trigger('change');
                $("#notes").val($(this).data('notes'));

                $("#set-status").dialog({
                    modal: true
                });
            });
        });
    </script>
}
